{% extends 'base_front.html.twig' %}

{% block title %}DÃ©tails de la tÃ¢che{% endblock %}

{% block body %}
<div class="container mt-5">
    <div class="task-card shadow-sm">
        <div class="task-header d-flex justify-content-between align-items-start mb-3">
            <div>
                <h1 class="h4 mb-1">{{ task.getTaskTitle() }}</h1>
                {% if task.getTaskDesc() %}
                    <p class="text-muted mb-1">{{ task.getTaskDesc() }}</p>
                {% endif %}
            {% if task.getTaskProject() %}
                <div class="task-actions mt-3">
                    <a href="{{ path('front_project_show', {'id': task.getTaskProject().id}) }}" class="btn-glass">
                        <i class="bi bi-eye"></i> Voir le projet : {{ task.getTaskProject().projectName }}
                    </a>
                </div>
            {% endif %}
            </div>
            {% if task.getTaskDueDate() %}
                <span class="task-date">{{ task.getTaskDueDate()|date('d F Y') }}</span>
            {% endif %}
        </div>

        <div class="task-meta d-flex flex-wrap gap-2 mb-3">
            {# PRIORITÃ‰ #}
            {% if task.getTaskPriority() %}
                {% set priorityName = task.getTaskPriority().getPriorityName() %}
                {% set priorityMap = {
                    'Tres faible': 'tres-faible',
                    'Faible': 'faible',
                    'Modere': 'modere',
                    'Eleve': 'eleve',
                    'Tres eleve': 'tres-eleve'
                } %}
                {% set priorityClass = priorityMap[priorityName]|default('') %}
                <span class="priority-badge {{ priorityClass ? 'priority-' ~ priorityClass : '' }}">
                    {{ priorityName }}
                </span>
            {% endif %}

            {# STATUT #}
            {% if task.getTaskStatus() %}
                {% set statusName = task.getTaskStatus().getStatusName() %}
                {% set statusMap = {
                    'En cours': 'en-cours',
                    'Terminee': 'termine',
                    'En retard': 'retard',
                    'En attente': 'en-attente'
                } %}
                {% set statusClass = statusMap[statusName]|default('') %}
                <span class="status-badge {{ statusClass ? 'status-' ~ statusClass : '' }}">
                    {{ statusName }}
                </span>
            {% endif %}

            {% if task.getTaskCreatedAt() %}
                <span class="meta-pill">CrÃ©Ã©e le {{ task.getTaskCreatedAt()|date('d F Y') }}</span>
            {% endif %}
            {% if task.getTaskLastChange() %}
                <span class="meta-pill">ModifiÃ©e le {{ task.getTaskLastChange()|date('d F Y') }}</span>
            {% endif %}
        </div>

        <div class="task-actions d-flex justify-content-between mt-4">
            <a href="{{ path('front_tasks_by_project', { id: task.taskProject.id }) }}" class="btn-glass">
                <i class="bi bi-arrow-left"></i> Retour Ã  la liste
            </a>

            <div class="d-flex gap-2">

                {% if task.taskProject.users.contains(app.user) %}
                    <a href="{{ path('front_tasks_edit', {'id': task.id}) }}" class="btn-glass">
                        <i class="bi bi-pencil"></i> Modifier
                    </a>

                    {{ include('front/tasks/_delete_form.html.twig', { task: task }) }}
                {% endif %}

            </div>
        </div>

    </div>

    {# ðŸŸ¦ BLOC HISTORIQUE DES MODIFICATIONS #}
    <div class="task-card shadow-sm mt-4">
        <h3 class="h5 mb-3">ðŸ•’ Historique des modifications</h3>

        <ul class="history-list">
            {% for entry in task.history %}
                <li>
                    <strong>{{ entry.thUpdatedAt|date('d/m/Y H:i') }}</strong> â€” 
                    {{ entry.thChangelog }}
                    {% if entry.author %}
                        <em>(par {{ entry.author.name }})</em>
                    {% endif %}
                </li>
            {% else %}
                <p class="text-muted">Aucune modification enregistrÃ©e.</p>
            {% endfor %}
        </ul>
    </div>

</div>
{% endblock %}
