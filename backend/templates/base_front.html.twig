<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>{% block title %}GestionProjet - Front{% endblock %}</title>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<<<<<<< HEAD
=======

>>>>>>> d1cec7c (notification)
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

        <link rel="stylesheet" href="{{ asset('css/accueil.css') }}">
        <link rel="stylesheet" href="{{ asset('css/projet.css') }}">
        <link rel="stylesheet" href="{{ asset('css/task.css') }}">
        <link rel="stylesheet" href="{{ asset('css/user.css') }}">

        <style>
            .notif-wrapper { position: relative; display: inline-block; }
            .notif-badge {
                position: absolute;
                top: -5px; right: -5px;
                background-color: #dc3545; color: white;
                border-radius: 50%; padding: 2px 6px;
                font-size: 10px; font-weight: bold;
                display: none; z-index: 10;
            }
        </style>
    </head>

    <body>
        <div class="page-background">
            <div class="layout">

<<<<<<< HEAD
                {% if app.user %}
                <nav class="sidebar">

=======
                <nav class="sidebar">
                    
>>>>>>> d1cec7c (notification)
                    <div class="sidebar-header">
                        <div class="logo-box">
                            <i class="fa-solid fa-briefcase me-2"></i>
                            BManager
                        </div>

                        <div class="sidebar-actions">
<<<<<<< HEAD
                            <div class="notif-wrapper">
                                <a href="#" class="notif-icon disabled">
                                    <i class="fa-solid fa-bell"></i>
                                </a>
                            </div>

=======
                            {% if app.user %}
                                <div class="notif-wrapper">
                                    <a href="#" id="notif-open" class="notif-icon">
                                        <i class="fa-solid fa-bell"></i>
                                        <span class="notif-badge">0</span>
                                    </a>

                                </div>
                            {% endif %}


>>>>>>> d1cec7c (notification)
                            <div class="dark-mode-wrapper">
                                <label class="switch" id="switch">
                                    <input type="checkbox">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="sidebar-content">
                        <ul class="nav flex-column">

                            <li class="nav-item mb-2">
                                <a href="{{ path('front_accueil') }}"
                                   class="nav-link {% if app.request.attributes.get('_route') == 'app_accueil' %}active{% endif %}">
                                    <i class="fa-solid fa-chart-line me-2"></i> Dashboard
                                </a>
                            </li>

                            <li class="nav-item mb-2">
                                <a class="nav-link d-flex justify-content-between align-items-center"
                                   data-bs-toggle="collapse" href="#menuProjets" role="button">
                                    <span><i class="fa-solid fa-folder-open me-2"></i> Projets</span>
                                    <i class="fa-solid fa-chevron-down"></i>
                                </a>
                                <div class="collapse" id="menuProjets">
                                    <ul class="nav flex-column sub-menu">
                                        <li class="nav-item">
                                            <a href="{{ path('front_project_index') }}" class="nav-link">
                                                <i class="fa-solid fa-list me-2"></i> G√©rer les projets
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </li>

                            <li class="nav-item mb-2">
                                <a class="nav-link d-flex justify-content-between align-items-center"
                                   data-bs-toggle="collapse" href="#menuTaches" role="button">
                                    <span><i class="fa-solid fa-list-check me-2"></i> T√¢ches</span>
                                    <i class="fa-solid fa-chevron-down"></i>
                                </a>
                                <div class="collapse" id="menuTaches">
                                    <ul class="nav flex-column sub-menu">
                                        <li class="nav-item">
                                            <a href="{{ path('front_tasks_index') }}" class="nav-link">
                                                <i class="fa-solid fa-list me-2"></i> G√©rer les t√¢ches
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </li>

                            {% if is_granted('ROLE_ADMIN') %}
                            <li class="nav-item mb-2">
                                <a class="nav-link d-flex justify-content-between align-items-center"
                                   data-bs-toggle="collapse" href="#menuStats" role="button">
                                    <span><i class="fa-solid fa-chart-area me-2"></i> Statistiques</span>
                                    <i class="fa-solid fa-chevron-down"></i>
                                </a>
                            </li>

<<<<<<< HEAD
=======
                            {% if is_granted('ROLE_ADMIN') %}
>>>>>>> d1cec7c (notification)
                            <li class="nav-item mb-2">
                                <a class="nav-link d-flex justify-content-between align-items-center"
                                   data-bs-toggle="collapse" href="#menuUsers" role="button">
                                    <span><i class="fa-solid fa-users me-2"></i> Utilisateurs</span>
                                    <i class="fa-solid fa-chevron-down"></i>
                                </a>
                                <div class="collapse" id="menuUsers">
                                    <ul class="nav flex-column sub-menu">
                                        <li class="nav-item">
                                            <a href="{{ path('user_index') }}" class="nav-link">
                                                <i class="fa-solid fa-users-gear me-2"></i> G√©rer les utilisateurs
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </li>
                            {% endif %}

<<<<<<< HEAD
=======
                            {% if app.user %}
>>>>>>> d1cec7c (notification)
                            <li class="nav-item mb-2">
                                <a href="{{ path('app_logout') }}" class="nav-link">
                                    <i class="fa-solid fa-right-from-bracket me-2"></i> D√©connexion
                                </a>
                            </li>

                        </ul>
                    </div>
                </nav>
                {% endif %}

                <main>
                    {% block body %}{% endblock %}
                </main>

            </div>
        </div>

        {% if app.user %}
        <div id="notif-overlay" class="notif-overlay"></div>

        <div id="notif-panel" class="notif-panel">
            <div class="notif-header">
            <div id="notif-content" class="notif-content"></div>
                <h3>Notifications</h3>
                <button id="notif-close" class="notif-close">&times;</button>
            </div>

            

            <div class="notif-footer">
                <span class="notif-read-all text-muted">Notifications d√©sactiv√©es</span>
            </div>
        </div>
        {% endif %}

        <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            const darkModeToggle = document.querySelector('#switch input'); 
            const darkModePref = localStorage.getItem('darkMode');

            if (darkModePref === 'enabled') {
                document.body.classList.add('dark-mode');
                if (darkModeToggle) darkModeToggle.checked = true;
            }

<<<<<<< HEAD
            darkModeToggle.addEventListener('change', function() {
                if (this.checked) {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('darkMode', 'enabled');
                } else {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('darkMode', 'disabled');
                }
            });
        </script>

        {% if app.user %}
        <script>
            try {
                const userId = {{ app.user.id }};
                const url = "http://localhost:3000/.well-known/mercure?topic=" + encodeURIComponent("user/" + userId + "/notifications");

                const eventSource = new EventSource(url);

                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);

                    const badge = document.querySelector(".notif-badge");
                    if (badge) {
                        badge.textContent = parseInt(badge.textContent || 0) + 1;
                    } else {
                        const icon = document.querySelector(".notif-icon");
                        const span = document.createElement("span");
                        span.classList.add("notif-badge");
                        span.textContent = "1";
                        icon.appendChild(span);
                    }

                    const panel = document.querySelector(".notif-content");
                    const div = document.createElement("div");
                    div.classList.add("notif-item", "unread");
                    div.innerHTML = `
                        <div class="notif-message">
                            <strong>${data.createdAt}</strong>
                            ${data.message}
                        </div>
                    `;
                    panel.prepend(div);
                };
            } catch (e) {
                console.warn("Mercure indisponible.");
            }
        </script>
        {% endif %}
=======
            if (darkModeToggle) {
                darkModeToggle.addEventListener('change', function() {
                    if (this.checked) {
                        document.body.classList.add('dark-mode');
                        localStorage.setItem('darkMode', 'enabled');
                    } else {
                        document.body.classList.remove('dark-mode');
                        localStorage.setItem('darkMode', 'disabled');
                    }
                });
            }

            // ============================
            // üîî PANEL NOTIFICATIONS JS
            // ============================

            const notifOpen = document.getElementById("notif-open");
            const notifPanel = document.getElementById("notif-panel");
            const notifOverlay = document.getElementById("notif-overlay");
            const notifClose = document.getElementById("notif-close");

            if (notifOpen) {
                notifOpen.addEventListener("click", (e) => {
                    e.preventDefault();
                    notifPanel.classList.add("open");
                    notifOverlay.classList.add("visible");
                });
            }

            if (notifClose) {
                notifClose.addEventListener("click", () => {
                    notifPanel.classList.remove("open");
                    notifOverlay.classList.remove("visible");
                });
            }

            if (notifOverlay) {
                notifOverlay.addEventListener("click", () => {
                    notifPanel.classList.remove("open");
                    notifOverlay.classList.remove("visible");
                });
            }
        </script>
        
        <script>
            {% if app.user %}
                function checkNotifications() {
                    fetch("/notification/ajax/unread")
                        .then(response => {
                            if(response.ok) return response.text();
                            throw new Error('Erreur r√©seau');
                        })
                        .then(html => {
                            // 1. Mise √† jour du contenu du panel
                            const panel = document.querySelector(".notif-content");
                            if (panel) panel.innerHTML = html;

                            // 2. Mise √† jour du badge rouge
                            // On compte les √©l√©ments .notif-item re√ßus dans le HTML
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = html;
                            const count = tempDiv.querySelectorAll('.notif-item').length;

                            const badge = document.querySelector(".notif-badge");
                            if (badge) {
                                if (count > 0) {
                                    badge.textContent = count;
                                    badge.style.display = "inline-block";
                                } else {
                                    badge.style.display = "none";
                                }
                            }
                        })
                        .catch(err => console.error("Erreur check notifs:", err));
                }

                // Lancer au chargement
                document.addEventListener("DOMContentLoaded", checkNotifications);
                
                // Relancer toutes les 5 secondes
                setInterval(checkNotifications, 5000);
            {% endif %}
        </script>

        <script>
document.addEventListener('DOMContentLoaded', function () {
    const notifOpen = document.getElementById('notif-open');
    const notifPanel = document.getElementById('notif-panel');
    const notifOverlay = document.getElementById('notif-overlay');
    const notifClose = document.getElementById('notif-close');
    const notifContent = document.getElementById('notif-content');

    notifOpen.addEventListener('click', function (e) {
        e.preventDefault();
        notifPanel.classList.add('open');
        notifOverlay.classList.add('active');

        fetch('/notification/ajax/unread')
            .then(response => response.text())
            .then(html => {
                notifContent.innerHTML = html;
            });
    });

    notifClose.addEventListener('click', function () {
        notifPanel.classList.remove('open');
        notifOverlay.classList.remove('active');
    });

    notifOverlay.addEventListener('click', function () {
        notifPanel.classList.remove('open');
        notifOverlay.classList.remove('active');
    });
});
</script>

>>>>>>> d1cec7c (notification)
    </body>
</html>
