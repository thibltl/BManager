<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>{% block title %}GestionProjet - Front{% endblock %}</title>

        <!-- Bootstrap -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

        <!-- FontAwesome -->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

        <!-- Ton CSS personnalisÃ© -->
        <link rel="stylesheet" href="{{ asset('css/accueil.css') }}">
        <link rel="stylesheet" href="{{ asset('css/projet.css') }}">
        <link rel="stylesheet" href="{{ asset('css/task.css') }}">
        <link rel="stylesheet" href="{{ asset('css/user.css') }}">

        
    </head>

    <body>
        <div class="page-background">
            <div class="layout">

                <!-- Sidebar -->
                <nav class="sidebar">
                    
                    <!-- HEADER SIDEBAR -->
                    <div class="sidebar-header">
                        <!-- Logo -->
                        <div class="logo-box">
                            BManager
                        </div>

                        <!-- Actions (Notifications + Dark Mode) -->
                        <div class="sidebar-actions">
                            <!-- ðŸ”” Notifications -->
                            {% if app.user %}
                                <div class="notif-wrapper">
                                    <a href="#" class="notif-icon" id="notif-open">
                                        <i class="fa-solid fa-bell"></i>
                                        {% set unread = app.user.notifications|filter(n => not n.isRead)|length %}
                                        {% if unread > 0 %}
                                            <span class="notif-badge">{{ unread }}</span>
                                        {% endif %}
                                    </a>
                                </div>
                            {% endif %}

                            <!-- ðŸŒ™ Dark Mode -->
                            <div class="dark-mode-wrapper">
                                <label class="switch" id="switch">
                                    <input type="checkbox">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- NAVIGATION -->
                    <ul class="nav flex-column">

                        <!-- Dashboard -->
                        <li class="nav-item mb-2">
                            <a href="{{ path('front_accueil') }}"
                               class="nav-link {% if app.request.attributes.get('_route') == 'app_accueil' %}active{% endif %}">
                                <i class="fa-solid fa-chart-line me-2"></i> Dashboard
                            </a>
                        </li>

                        <!-- Menu Projets -->
                        <li class="nav-item mb-2">
                            <a class="nav-link d-flex justify-content-between align-items-center"
                               data-bs-toggle="collapse" href="#menuProjets" role="button">
                                <span><i class="fa-solid fa-folder-open me-2"></i> Projets</span>
                                <i class="fa-solid fa-chevron-down"></i>
                            </a>
                            <div class="collapse" id="menuProjets">
                                <ul class="nav flex-column sub-menu">
                                    <li class="nav-item">
                                        <a href="{{ path('front_project_index') }}" class="nav-link">
                                            <i class="fa-solid fa-list me-2"></i> GÃ©rer les projets
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </li>

                        <!-- Menu TÃ¢ches -->
                        <li class="nav-item mb-2">
                            <a class="nav-link d-flex justify-content-between align-items-center"
                               data-bs-toggle="collapse" href="#menuTaches" role="button">
                                <span><i class="fa-solid fa-list-check me-2"></i> TÃ¢ches</span>
                                <i class="fa-solid fa-chevron-down"></i>
                            </a>
                            <div class="collapse" id="menuTaches">
                                <ul class="nav flex-column sub-menu">
                                    <li class="nav-item">
                                        <a href="{{ path('front_project_index') }}" class="nav-link">
                                            <i class="fa-solid fa-list me-2"></i> GÃ©rer les tÃ¢ches
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </li>

                        <!-- Menu Stats (admin) -->
                        {% if is_granted('ROLE_ADMIN') %}
                        <li class="nav-item mb-2">
                            <a class="nav-link d-flex justify-content-between align-items-center"
                               data-bs-toggle="collapse" href="#menuStats" role="button">
                                <span><i class="fa-solid fa-chart-area me-2 ms-1"></i> Statistiques</span>
                                <i class="fa-solid fa-chevron-down"></i>
                            </a>
                        </li>
                        {% endif %}

                        <!-- Menu Utilisateurs (admin) -->
                        {% if is_granted('ROLE_ADMIN') %}
                        <li class="nav-item mb-2">
                            <a class="nav-link d-flex justify-content-between align-items-center"
                               data-bs-toggle="collapse" href="#menuUsers" role="button">
                                <span><i class="fa-solid fa-user me-2 ms-1"></i> Utilisateurs</span>
                                <i class="fa-solid fa-chevron-down"></i>
                            </a>
                            <div class="collapse" id="menuUsers">
                                <ul class="nav flex-column sub-menu">
                                    <li class="nav-item">
                                        <a href="{{ path('user_index') }}" class="nav-link">
                                            <i class="fa-solid fa-user me-2 ms-1"></i> GÃ©rer les utilisateurs
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </li>
                        {% endif %}
                    </ul>
                </nav>

                <!-- Contenu principal -->
                <main>
                    {% block body %}{% endblock %}
                </main>

            </div>
        </div>

        <!-- =============================== -->
        <!-- ðŸ”” PANEL DE NOTIFICATIONS -->
        <!-- =============================== -->

        {% if app.user %}
        <div id="notif-overlay" class="notif-overlay"></div>

        <div id="notif-panel" class="notif-panel">
            <div class="notif-header">
                <h3>Notifications</h3>
                <button id="notif-close" class="notif-close">&times;</button>
            </div>

            <div class="notif-content">
                {% for notif in app.user.notifications|sort((a, b) => b.createdAt <=> a.createdAt) %}
                    <div class="notif-item {{ notif.isRead ? 'read' : 'unread' }}">
                        <div class="notif-message">
                            <strong>{{ notif.createdAt|date('d/m/Y H:i') }}</strong>
                            {{ notif.message }}
                        </div>

                        {% if not notif.isRead %}
                            <a href="{{ path('notifications_read', {id: notif.id}) }}" class="notif-mark-read">
                                Marquer comme lu
                            </a>
                        {% endif %}
                    </div>
                {% else %}
                    <p class="text-muted">Aucune notification.</p>
                {% endfor %}
            </div>

            <div class="notif-footer">
                <a href="{{ path('notifications_read_all') }}" class="notif-read-all">Tout marquer comme lu</a>
            </div>
        </div>
        {% endif %}

        <!-- Scripts -->
        <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            const darkModeToggle = document.querySelector('#switch input'); 
            const darkModePref = localStorage.getItem('darkMode');

            if (darkModePref === 'enabled') {
                document.body.classList.add('dark-mode');
                darkModeToggle.checked = true;
            }

            darkModeToggle.addEventListener('change', function() {
                if (this.checked) {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('darkMode', 'enabled');
                } else {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('darkMode', 'disabled');
                }
            });

            // ============================
            // ðŸ”” PANEL NOTIFICATIONS JS
            // ============================

            const notifOpen = document.getElementById("notif-open");
            const notifPanel = document.getElementById("notif-panel");
            const notifOverlay = document.getElementById("notif-overlay");
            const notifClose = document.getElementById("notif-close");

            if (notifOpen) {
                notifOpen.addEventListener("click", (e) => {
                    e.preventDefault();
                    notifPanel.classList.add("open");
                    notifOverlay.classList.add("visible");
                });
            }

            if (notifClose) {
                notifClose.addEventListener("click", () => {
                    notifPanel.classList.remove("open");
                    notifOverlay.classList.remove("visible");
                });
            }

            if (notifOverlay) {
                notifOverlay.addEventListener("click", () => {
                    notifPanel.classList.remove("open");
                    notifOverlay.classList.remove("visible");
                });
            }
        </script>
        <script>
            {% if app.user %}
            const userId = {{ app.user.id }};
            const url = "http://localhost:3000/.well-known/mercure?topic=" + encodeURIComponent("user/" + userId + "/notifications");

            const eventSource = new EventSource(url);

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);

                // ðŸ”¥ Mettre Ã  jour le badge
                const badge = document.querySelector(".notif-badge");
                if (badge) {
                    badge.textContent = parseInt(badge.textContent || 0) + 1;
                } else {
                    const icon = document.querySelector(".notif-icon");
                    const span = document.createElement("span");
                    span.classList.add("notif-badge");
                    span.textContent = "1";
                    icon.appendChild(span);
                }

                // ðŸ”¥ Ajouter la notification dans le panneau
                const panel = document.querySelector(".notif-content");
                const div = document.createElement("div");
                div.classList.add("notif-item", "unread");
                div.innerHTML = `
                    <div class="notif-message">
                        <strong>${data.createdAt}</strong>
                        ${data.message}
                    </div>
                `;
                panel.prepend(div);
            };
            {% endif %}
        </script>
    </body>
</html>