<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>{% block title %}GestionProjet - Front{% endblock %}</title>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

        <link rel="stylesheet" href="{{ asset('css/accueil.css') }}">
        <link rel="stylesheet" href="{{ asset('css/projet.css') }}">
        <link rel="stylesheet" href="{{ asset('css/task.css') }}">
        <link rel="stylesheet" href="{{ asset('css/user.css') }}">
    </head>

    <body>
        <div class="page-background">
            <div class="layout">

                {% if app.user %}
                <nav class="sidebar">

                    <div class="sidebar-header">
                        <div class="logo-box">
                            <i class="fa-solid fa-briefcase me-2"></i>
                            BManager
                        </div>

                        <div class="sidebar-actions">
                            <div class="notif-wrapper">
                                <a href="#" class="notif-icon disabled">
                                    <i class="fa-solid fa-bell"></i>
                                </a>
                            </div>

                            <div class="dark-mode-wrapper">
                                <label class="switch" id="switch">
                                    <input type="checkbox">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="sidebar-content">
                        <ul class="nav flex-column">

                            <li class="nav-item mb-2">
                                <a href="{{ path('front_accueil') }}"
                                   class="nav-link {% if app.request.attributes.get('_route') == 'app_accueil' %}active{% endif %}">
                                    <i class="fa-solid fa-chart-line me-2"></i> Dashboard
                                </a>
                            </li>

                            <li class="nav-item mb-2">
                                <a class="nav-link d-flex justify-content-between align-items-center"
                                   data-bs-toggle="collapse" href="#menuProjets" role="button">
                                    <span><i class="fa-solid fa-folder-open me-2"></i> Projets</span>
                                    <i class="fa-solid fa-chevron-down"></i>
                                </a>
                                <div class="collapse" id="menuProjets">
                                    <ul class="nav flex-column sub-menu">
                                        <li class="nav-item">
                                            <a href="{{ path('front_project_index') }}" class="nav-link">
                                                <i class="fa-solid fa-list me-2"></i> Gérer les projets
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </li>

                            <li class="nav-item mb-2">
                                <a class="nav-link d-flex justify-content-between align-items-center"
                                   data-bs-toggle="collapse" href="#menuTaches" role="button">
                                    <span><i class="fa-solid fa-list-check me-2"></i> Tâches</span>
                                    <i class="fa-solid fa-chevron-down"></i>
                                </a>
                                <div class="collapse" id="menuTaches">
                                    <ul class="nav flex-column sub-menu">
                                        <li class="nav-item">
                                            <a href="{{ path('front_tasks_index') }}" class="nav-link">
                                                <i class="fa-solid fa-list me-2"></i> Gérer les tâches
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </li>

                            {% if is_granted('ROLE_ADMIN') %}
                            <li class="nav-item mb-2">
                                <a class="nav-link d-flex justify-content-between align-items-center"
                                   data-bs-toggle="collapse" href="#menuStats" role="button">
                                    <span><i class="fa-solid fa-chart-area me-2"></i> Statistiques</span>
                                    <i class="fa-solid fa-chevron-down"></i>
                                </a>
                            </li>

                            <li class="nav-item mb-2">
                                <a class="nav-link d-flex justify-content-between align-items-center"
                                   data-bs-toggle="collapse" href="#menuUsers" role="button">
                                    <span><i class="fa-solid fa-users me-2"></i> Utilisateurs</span>
                                    <i class="fa-solid fa-chevron-down"></i>
                                </a>
                                <div class="collapse" id="menuUsers">
                                    <ul class="nav flex-column sub-menu">
                                        <li class="nav-item">
                                            <a href="{{ path('user_index') }}" class="nav-link">
                                                <i class="fa-solid fa-users-gear me-2"></i> Gérer les utilisateurs
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </li>
                            {% endif %}

                            <li class="nav-item mb-2">
                                <a href="{{ path('app_logout') }}" class="nav-link">
                                    <i class="fa-solid fa-right-from-bracket me-2"></i> Déconnexion
                                </a>
                            </li>

                        </ul>
                    </div>
                </nav>
                {% endif %}

                <main>
                    {% block body %}{% endblock %}
                </main>

            </div>
        </div>

        {% if app.user %}
        <div id="notif-overlay" class="notif-overlay"></div>

        <div id="notif-panel" class="notif-panel">
            <div class="notif-header">
                <h3>Notifications</h3>
                <button id="notif-close" class="notif-close">&times;</button>
            </div>

            <div class="notif-content">
                <div class="notif-item read">
                    <div class="notif-message">
                        <strong>—</strong>
                        Notifications désactivées
                    </div>
                </div>
            </div>

            <div class="notif-footer">
                <span class="notif-read-all text-muted">Notifications désactivées</span>
            </div>
        </div>
        {% endif %}

        <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            const darkModeToggle = document.querySelector('#switch input'); 
            const darkModePref = localStorage.getItem('darkMode');

            if (darkModePref === 'enabled') {
                document.body.classList.add('dark-mode');
                darkModeToggle.checked = true;
            }

            darkModeToggle.addEventListener('change', function() {
                if (this.checked) {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('darkMode', 'enabled');
                } else {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('darkMode', 'disabled');
                }
            });
        </script>

        {% if app.user %}
        <script>
            try {
                const userId = {{ app.user.id }};
                const url = "http://localhost:3000/.well-known/mercure?topic=" + encodeURIComponent("user/" + userId + "/notifications");

                const eventSource = new EventSource(url);

                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);

                    const badge = document.querySelector(".notif-badge");
                    if (badge) {
                        badge.textContent = parseInt(badge.textContent || 0) + 1;
                    } else {
                        const icon = document.querySelector(".notif-icon");
                        const span = document.createElement("span");
                        span.classList.add("notif-badge");
                        span.textContent = "1";
                        icon.appendChild(span);
                    }

                    const panel = document.querySelector(".notif-content");
                    const div = document.createElement("div");
                    div.classList.add("notif-item", "unread");
                    div.innerHTML = `
                        <div class="notif-message">
                            <strong>${data.createdAt}</strong>
                            ${data.message}
                        </div>
                    `;
                    panel.prepend(div);
                };
            } catch (e) {
                console.warn("Mercure indisponible.");
            }
        </script>
        {% endif %}
    </body>
</html>
