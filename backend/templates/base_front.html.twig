<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{% block title %}GestionProjet - Front{% endblock %}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <link rel="stylesheet" href="{{ asset('css/accueil.css') }}">
    <link rel="stylesheet" href="{{ asset('css/projet.css') }}">
    <link rel="stylesheet" href="{{ asset('css/task.css') }}">
    <link rel="stylesheet" href="{{ asset('css/user.css') }}">

    <style>
        .notif-wrapper { position: relative; display: inline-block; }
        .notif-badge {
            position: absolute;
            top: -5px; right: -5px;
            background-color: #dc3545; color: white;
            border-radius: 50%; padding: 2px 6px;
            font-size: 10px; font-weight: bold;
            display: none; z-index: 10;
        }
    </style>
</head>

<body>
<div class="page-background">
    <div class="layout">

        {% if app.user %}
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo-box">
                    <i class="fa-solid fa-briefcase me-2"></i>
                    BManager
                </div>

                <div class="sidebar-actions">
                    <div class="notif-wrapper">
                        <a href="#" id="notif-open" class="notif-icon">
                            <i class="fa-solid fa-bell"></i>
                            <span class="notif-badge">0</span>
                        </a>
                    </div>

                    <div class="dark-mode-wrapper">
                        <label class="switch" id="switch">
                            <input type="checkbox">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="sidebar-content">
                <ul class="nav flex-column">

                    <li class="nav-item mb-2">
                        <a href="{{ path('front_accueil') }}"
                           class="nav-link {% if app.request.attributes.get('_route') == 'front_accueil' %}active{% endif %}">
                            <i class="fa-solid fa-chart-line me-2"></i> Dashboard
                        </a>
                    </li>

                    <li class="nav-item mb-2">
                        <a class="nav-link d-flex justify-content-between align-items-center"
                           data-bs-toggle="collapse" href="#menuProjets">
                            <span><i class="fa-solid fa-folder-open me-2"></i> Projets</span>
                            <i class="fa-solid fa-chevron-down"></i>
                        </a>
                        <div class="collapse" id="menuProjets">
                            <ul class="nav flex-column sub-menu">
                                <li class="nav-item">
                                    <a href="{{ path('front_project_index') }}" class="nav-link">
                                        <i class="fa-solid fa-list me-2"></i> Gérer les projets
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </li>

                    <li class="nav-item mb-2">
                        <a class="nav-link d-flex justify-content-between align-items-center"
                           data-bs-toggle="collapse" href="#menuTaches">
                            <span><i class="fa-solid fa-list-check me-2"></i> Tâches</span>
                            <i class="fa-solid fa-chevron-down"></i>
                        </a>
                        <div class="collapse" id="menuTaches">
                            <ul class="nav flex-column sub-menu">
                                <li class="nav-item">
                                    <a href="{{ path('front_tasks_index') }}" class="nav-link">
                                        <i class="fa-solid fa-list me-2"></i> Gérer les tâches
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </li>

                    {% if is_granted('ROLE_ADMIN') %}
                    <li class="nav-item mb-2">
                        <a class="nav-link d-flex justify-content-between align-items-center"
                           data-bs-toggle="collapse" href="#menuUsers">
                            <span><i class="fa-solid fa-users me-2"></i> Utilisateurs</span>
                            <i class="fa-solid fa-chevron-down"></i>
                        </a>
                        <div class="collapse" id="menuUsers">
                            <ul class="nav flex-column sub-menu">
                                <li class="nav-item">
                                    <a href="{{ path('user_index') }}" class="nav-link">
                                        <i class="fa-solid fa-users-gear me-2"></i> Gérer les utilisateurs
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </li>
                    {% endif %}

                    <li class="nav-item mb-2">
                        <a href="{{ path('app_logout') }}" class="nav-link">
                            <i class="fa-solid fa-right-from-bracket me-2"></i> Déconnexion
                        </a>
                    </li>

                </ul>
            </div>
        </nav>
        {% endif %}

        <main>
            {% block body %}{% endblock %}
        </main>

    </div>
</div>

{% if app.user %}
<div id="notif-overlay" class="notif-overlay"></div>

<div id="notif-panel" class="notif-panel">
    <div class="notif-header">
        <h3>Notifications</h3>
        <button id="notif-close" class="notif-close">&times;</button>
    </div>

    <div id="notif-content" class="notif-content"></div>

    <div class="notif-footer">
        <span class="notif-read-all text-muted">Notifications désactivées</span>
    </div>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const darkModeToggle = document.querySelector('#switch input');
    const darkModePref = localStorage.getItem('darkMode');

    if (darkModePref === 'enabled') {
        document.body.classList.add('dark-mode');
        if (darkModeToggle) darkModeToggle.checked = true;
    }

    if (darkModeToggle) {
        darkModeToggle.addEventListener('change', function() {
            if (this.checked) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('darkMode', 'enabled');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('darkMode', 'disabled');
            }
        });
    }
</script>

{% if app.user %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const notifOpen = document.getElementById('notif-open');
    const notifPanel = document.getElementById('notif-panel');
    const notifOverlay = document.getElementById('notif-overlay');
    const notifClose = document.getElementById('notif-close');
    const notifContent = document.getElementById('notif-content');

    if (!notifOpen || !notifPanel || !notifOverlay || !notifClose || !notifContent) {
        return;
    }

    notifOpen.addEventListener('click', function (e) {
        e.preventDefault();
        notifPanel.classList.add('open');
        notifOverlay.classList.add('active');

        fetch('/notification/ajax/unread')
            .then(response => response.text())
            .then(html => {
                notifContent.innerHTML = html;
            });
    });

    notifClose.addEventListener('click', function () {
        notifPanel.classList.remove('open');
        notifOverlay.classList.remove('active');
    });

    notifOverlay.addEventListener('click', function () {
        notifPanel.classList.remove('open');
        notifOverlay.classList.remove('active');
    });
});
</script>

<script>
function checkNotifications() {
    fetch("/notification/ajax/unread")
        .then(response => response.text())
        .then(html => {
            const panel = document.querySelector(".notif-content");
            if (panel) panel.innerHTML = html;

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const count = tempDiv.querySelectorAll('.notif-item').length;

            const badge = document.querySelector(".notif-badge");
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = "inline-block";
                } else {
                    badge.style.display = "none";
                }
            }
        })
        .catch(err => console.error("Erreur check notifs:", err));
}

document.addEventListener("DOMContentLoaded", checkNotifications);
setInterval(checkNotifications, 5000);
</script>
{% endif %}

</body>
</html>
